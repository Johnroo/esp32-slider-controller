<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Slider Controller - Advanced</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }
        
        .panel:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .panel h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 10px;
        }
        
        .panel-black {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
        }
        
        .panel-black h3 {
            color: #495057;
            border-bottom: 2px solid #dee2e6;
        }

        .control-panel {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }

        .motor-config {
            background: #ffffff;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #dee2e6;
        }

        .motor-config h4 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 14px;
        }

        .control-group.full-width {
            width: 100%;
        }

        .jog-control-container {
            display: flex;
            align-items: center;
            gap: 15px;
            width: 100%;
        }

        .jog-slider {
            flex: 1;
            min-width: 300px;
            height: 40px;
            background: #ddd;
            outline: none;
            border-radius: 20px;
            -webkit-appearance: none;
        }

        .jog-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 30px;
            height: 30px;
            background: #4CAF50;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        .jog-slider::-moz-range-thumb {
            width: 30px;
            height: 30px;
            background: #4CAF50;
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        .btn-reset {
            background: #ff9800;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .btn-reset:hover {
            background: #f57c00;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
        }
        
        .slider {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #dee2e6;
            outline: none;
            -webkit-appearance: none;
            transition: all 0.3s ease;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #007bff;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 123, 255, 0.3);
        }
        
        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #007bff;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0, 123, 255, 0.3);
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .input-group input {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #007bff;
        }
        
        .btn {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #dc3545, #c82333);
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(45deg, #28a745, #1e7e34);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
        
        .btn-warning {
            background: linear-gradient(45deg, #ffc107, #e0a800);
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
        }
        
        .preset-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        
        .preset-btn {
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-weight: 600;
            position: relative;
        }
        
        .preset-btn:hover {
            border-color: #007bff;
            background: #f8f9fa;
            transform: translateY(-2px);
        }
        
        /* √âtat: S√©lectionn√© (bleu) */
        .preset-btn.selected {
            background: #007bff;
            color: white;
            border-color: #007bff;
            box-shadow: 0 0 15px rgba(0, 123, 255, 0.4);
            transform: translateY(-2px);
        }
        
        /* √âtat: Sauv√© (rouge) */
        .preset-btn.saved {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
            box-shadow: 0 0 15px rgba(220, 53, 69, 0.4);
        }
        
        /* √âtat: Rappel√©/Actif (vert) */
        .preset-btn.recalled {
            background: #28a745;
            color: white;
            border-color: #28a745;
            box-shadow: 0 0 15px rgba(40, 167, 69, 0.4);
        }
        
        /* √âtat: En cours de rappel (clignotant blanc-vert) */
        .preset-btn.recalling {
            background: #28a745;
            color: white;
            border-color: #28a745;
            animation: recallingBlink 0.8s infinite;
        }
        
        @keyframes recallingBlink {
            0% { background: #28a745; }
            50% { background: #ffffff; color: #28a745; }
            100% { background: #28a745; }
        }
        
        /* Indicateur de statut */
        .preset-status {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: transparent;
        }
        
        .preset-btn.saved .preset-status {
            background: #ffc107;
        }
        
        .preset-btn.recalled .preset-status {
            background: #17a2b8;
        }
        
        .preset-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .preset-controls .btn {
            flex: 1;
            min-width: 120px;
        }
        
        .status {
            background: #e9ecef;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 14px;
        }
        
        .joystick-container {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .joy-flex { 
            display: flex; 
            gap: 24px; 
            align-items: center; 
            flex-wrap: wrap; 
        }
        .joy-visual { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
        }
        #joyCanvas { 
            background: #f8f9fa; 
            border-radius: 12px; 
            border: 2px solid #e9ecef;
        }
        #sliderJoystickGroup { 
            transition: opacity .2s ease; 
        }
        body[data-joy="connected"] #sliderJoystickGroup { 
            display: none; 
        }
        .hint { 
            font-size: 12px; 
            color: #6c757d; 
            margin-top: 6px; 
        }
        
        .joystick {
            flex: 1;
            text-align: center;
        }
        
        .joystick h4 {
            margin-bottom: 10px;
            color: #495057;
        }
        
        .value-display {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-family: monospace;
            font-weight: bold;
            color: #007bff;
        }
        
        .config-section {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .config-section h4 {
            color: #856404;
            margin-bottom: 15px;
        }
        
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé¨ ESP32 Slider Controller - Advanced</h1>
        
        <div class="grid">
            <!-- Presets Panel -->
            <div class="panel">
                <h3>üéØ Presets</h3>
                
                <!-- Bank Management -->
                <div class="control-group" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                    <h4 style="margin-bottom: 10px; color: #495057;">üè¶ Bank Management</h4>
                    
                    <div class="control-group">
                        <label>Active Bank:</label>
                        <select id="bankSelector">
                            <option value="0" selected>Bank 0</option>
                            <option value="1">Bank 1</option>
                            <option value="2">Bank 2</option>
                            <option value="3">Bank 3</option>
                            <option value="4">Bank 4</option>
                            <option value="5">Bank 5</option>
                            <option value="6">Bank 6</option>
                            <option value="7">Bank 7</option>
                            <option value="8">Bank 8</option>
                            <option value="9">Bank 9</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <button onclick="openBank()" class="btn-primary">üìÇ Open Bank</button>
                        <button onclick="saveBank()" class="btn-success">üíæ Save Bank</button>
                        <span id="bankStatus" style="margin-left: 10px; color: #4CAF50;">Ready</span>
                    </div>
                </div>
                <div class="preset-grid">
                    <div class="preset-btn" data-preset="0" onclick="selectPreset(0)">
                        Preset 0
                        <div class="preset-status"></div>
                    </div>
                    <div class="preset-btn" data-preset="1" onclick="selectPreset(1)">
                        Preset 1
                        <div class="preset-status"></div>
                    </div>
                    <div class="preset-btn" data-preset="2" onclick="selectPreset(2)">
                        Preset 2
                        <div class="preset-status"></div>
                    </div>
                    <div class="preset-btn" data-preset="3" onclick="selectPreset(3)">
                        Preset 3
                        <div class="preset-status"></div>
                    </div>
                    <div class="preset-btn" data-preset="4" onclick="selectPreset(4)">
                        Preset 4
                        <div class="preset-status"></div>
                    </div>
                    <div class="preset-btn" data-preset="5" onclick="selectPreset(5)">
                        Preset 5
                        <div class="preset-status"></div>
                    </div>
                    <div class="preset-btn" data-preset="6" onclick="selectPreset(6)">
                        Preset 6
                        <div class="preset-status"></div>
                    </div>
                    <div class="preset-btn" data-preset="7" onclick="selectPreset(7)">
                        Preset 7
                        <div class="preset-status"></div>
                    </div>
                </div>
                

                <div class="control-group">
                    <label>Duration (seconds):</label>
                    <input type="number" id="presetDuration" value="2.0" min="0.1" max="200.0" step="0.1">
                </div>
                
            <div class="preset-controls">
                <button class="btn btn-success" onclick="recallSelectedPreset()">‚ñ∂Ô∏è Recall Selected</button>
                <button class="btn" onclick="storeRealPreset()">üíæ Store (positions r√©elles)</button>
            </div>
            </div>
            
            <!-- Joystick Panel -->
            <div class="panel">
                <h3>üéÆ Joystick Controls</h3>

                <div class="joy-flex">
                    <div class="joy-visual">
                        <canvas id="joyCanvas" width="180" height="180"></canvas>
                        <div class="value-display">X: <span id="joyX">0.00</span> | Y: <span id="joyY">0.00</span></div>
                        <div id="joyHint" class="hint">Recherche d'un joystick USB‚Ä¶</div>
            <button class="btn" id="joyReconnectBtn" title="Rescanner le joystick" style="margin-top:8px">üîÅ Reconnect Joystick</button>
                    </div>

                    <!-- Fallback sliders (cach√©s si joystick connect√©) -->
                    <div id="sliderJoystickGroup">
                        <div class="joystick">
                            <h4>Pan Offset</h4>
                            <input type="range" class="slider" id="panOffset" min="-1" max="1" step="0.01" value="0">
                            <div class="value-display" id="panValue">0.00</div>
                        </div>
                        <div class="joystick">
                            <h4>Tilt Offset</h4>
                            <input type="range" class="slider" id="tiltOffset" min="-1" max="1" step="0.01" value="0">
                            <div class="value-display" id="tiltValue">0.00</div>
                        </div>
                    </div>
                </div>

                <button class="btn btn-warning" onclick="resetOffsets()">üîÑ Reset Offsets</button>
            </div>
            
            <!-- Direct Axis Controls -->
            <div class="panel">
                <h3>üéõÔ∏è Direct Axis Controls</h3>
                <div class="control-group">
                    <label>Pan (0 to 1):</label>
                    <input type="range" class="slider" id="axisPan" min="0" max="1" step="0.01" value="0.5">
                    <div class="value-display" id="axisPanValue">0.50</div>
                </div>
                
                <div class="control-group">
                    <label>Tilt (0 to 1):</label>
                    <input type="range" class="slider" id="axisTilt" min="0" max="1" step="0.01" value="0.5">
                    <div class="value-display" id="axisTiltValue">0.50</div>
                </div>
                
                <div class="control-group">
                    <label>Zoom (0 to 1):</label>
                    <input type="range" class="slider" id="axisZoom" min="0" max="1" step="0.01" value="0.5">
                    <div class="value-display" id="axisZoomValue">0.50</div>
                </div>
                
                <div class="control-group">
                    <label>Slide (0 to 1):</label>
                    <input type="range" class="slider" id="axisSlide" min="0" max="1" step="0.01" value="0.5">
                    <div class="value-display" id="axisSlideValue">0.50</div>
                </div>
            </div>
        </div>
        

        <!-- Multi-Preset Interpolation Axis -->
        <div class="control-panel">
            <h3>üéØ Interpolation Axis (Multi-Preset Morphing)</h3>
            
            <!-- Interpolation Points Configuration -->
            <div id="interpPointsContainer">
                <div class="control-group">
                    <label>Point A:</label>
                    <select id="interpPreset0">
                        <option value="0" selected>Preset 0</option>
                        <option value="1">Preset 1</option>
                        <option value="2">Preset 2</option>
                        <option value="3">Preset 3</option>
                        <option value="4">Preset 4</option>
                        <option value="5">Preset 5</option>
                        <option value="6">Preset 6</option>
                        <option value="7">Preset 7</option>
                    </select>
                    <span>@</span>
                    <input type="number" id="interpPos0" min="0" max="100" step="1" value="0" style="width: 60px;">
                    <span>%</span>
                </div>
                
                <div class="control-group">
                    <label>Point B:</label>
                    <select id="interpPreset1">
                        <option value="0">Preset 0</option>
                        <option value="1" selected>Preset 1</option>
                        <option value="2">Preset 2</option>
                        <option value="3">Preset 3</option>
                        <option value="4">Preset 4</option>
                        <option value="5">Preset 5</option>
                        <option value="6">Preset 6</option>
                        <option value="7">Preset 7</option>
                    </select>
                    <span>@</span>
                    <input type="number" id="interpPos1" min="0" max="100" step="1" value="100" style="width: 60px;">
                    <span>%</span>
                </div>
                
                <div id="extraInterpPoints"></div>
            </div>
            
            <div class="control-group">
                <button onclick="addInterpPoint()" class="btn-secondary" id="addPointBtn">+ Add Point (2/6)</button>
                <button onclick="applyInterpPoints()" class="btn-primary">Apply Points</button>
            </div>
            
            <hr>
            
            <!-- Mode Control -->
            <div class="control-group">
                <label>Mode:</label>
                <select id="interpMode" onchange="toggleInterpMode()">
                    <option value="manual" selected>Manual Jog</option>
                    <option value="auto">Auto Morphing</option>
                </select>
            </div>
            
            <!-- Manual Mode -->
            <div id="manualControls">
                <div class="control-group full-width">
                    <label>Jog Speed (-1 to +1):</label>
                    <div class="jog-control-container">
                        <input type="range" id="interpJogSlider" min="-1" max="1" step="0.01" value="0" oninput="updateInterpJogValue()" class="jog-slider">
                        <span id="interpJogValue">0.00</span>
                        <button onclick="resetInterpJog()" class="btn-reset">üîÑ Reset</button>
                    </div>
                </div>
            </div>
            
            <!-- Auto Mode -->
            <div id="autoControls" style="display: none;">
                <div class="control-group">
                    <label>Duration (seconds):</label>
                    <input type="number" id="interpAutoDuration" min="0.5" max="60.0" step="0.5" value="5.0" style="width: 80px;">
                    <span>s</span>
                </div>
                <div class="control-group">
                    <button onclick="startAutoMorphing()" class="btn-success">‚ñ∂Ô∏è Start Auto Morphing</button>
                    <button onclick="stopAutoMorphing()" class="btn-danger">‚èπÔ∏è Stop</button>
                </div>
            </div>
        </div>

        <!-- Motor Configuration -->
        <div class="control-panel">
            <h3>‚öôÔ∏è Motor Configuration</h3>
            
            <!-- Pan Motor -->
            <div class="motor-config">
                <h4>üéØ Pan Motor</h4>
                <div class="control-group">
                    <label>Max Speed (steps/s):</label>
                    <input type="number" id="panMaxSpeed" min="2000" max="20000" step="100" value="20000" onchange="updatePanSpeed()">
                    <span id="panSpeedValue">20000</span>
                </div>
                <div class="control-group">
                    <label>Max Acceleration (steps/s¬≤):</label>
                    <input type="number" id="panMaxAccel" min="1000" max="999999" step="100" value="12000" onchange="updatePanAccel()">
                    <span id="panAccelValue">12000</span>
                </div>
            </div>
            
            <!-- Tilt Motor -->
            <div class="motor-config">
                <h4>üìê Tilt Motor</h4>
                <div class="control-group">
                    <label>Max Speed (steps/s):</label>
                    <input type="number" id="tiltMaxSpeed" min="2000" max="20000" step="100" value="20000" onchange="updateTiltSpeed()">
                    <span id="tiltSpeedValue">20000</span>
                </div>
                <div class="control-group">
                    <label>Max Acceleration (steps/s¬≤):</label>
                    <input type="number" id="tiltMaxAccel" min="1000" max="999999" step="100" value="12000" onchange="updateTiltAccel()">
                    <span id="tiltAccelValue">12000</span>
                </div>
            </div>
            
            <!-- Zoom Motor -->
            <div class="motor-config">
                <h4>üîç Zoom Motor</h4>
                <div class="control-group">
                    <label>Max Speed (steps/s):</label>
                    <input type="number" id="zoomMaxSpeed" min="2000" max="20000" step="100" value="20000" onchange="updateZoomSpeed()">
                    <span id="zoomSpeedValue">20000</span>
                </div>
                <div class="control-group">
                    <label>Max Acceleration (steps/s¬≤):</label>
                    <input type="number" id="zoomMaxAccel" min="1000" max="999999" step="100" value="12000" onchange="updateZoomAccel()">
                    <span id="zoomAccelValue">12000</span>
                </div>
            </div>
            
            <!-- Slide Motor -->
            <div class="motor-config">
                <h4>üìè Slide Motor</h4>
                <div class="control-group">
                    <label>Max Speed (steps/s):</label>
                    <input type="number" id="slideMaxSpeed" min="2000" max="20000" step="100" value="20000" onchange="updateSlideSpeed()">
                    <span id="slideSpeedValue">20000</span>
                </div>
                <div class="control-group">
                    <label>Max Acceleration (steps/s¬≤):</label>
                    <input type="number" id="slideMaxAccel" min="1000" max="999999" step="100" value="12000" onchange="updateSlideAccel()">
                    <span id="slideAccelValue">12000</span>
                </div>
                
                <!-- Homing / StallGuard -->
                <hr style="margin: 15px 0; border-color: #444;">
                <div class="control-group">
                    <label>üè† Homing Slide (TMC2209 StallGuard):</label>
                    <button class="btn" id="btnSlideHome" onclick="homeSlide()">üè† Home Slide</button>
                </div>
                <div class="control-group">
                    <label>SGTHRS (0-255):</label>
                    <input type="range" id="sgthrsRange" min="0" max="255" value="8" step="1" style="width: 200px;" oninput="updateSGTHRS()">
                    <span id="sgthrsVal">8</span>
                </div>
                <div class="hint" style="font-size: 12px; color: #888; margin-top: 5px;">
                    Le homing utilise StallGuard (spreadCycle, TCOOLTHRS max). Ajuste SGTHRS si n√©cessaire.
                </div>
            </div>
        </div>
        
        <!-- Status -->
        <div class="status" id="status">
            Ready - Connected to ESP32
        </div>
    </div>

    <script>
document.getElementById('joyReconnectBtn')?.addEventListener('click', async () => {
  try {
    const r = await fetch('/api/joystick/rescan', { method: 'POST' });
    if (!r.ok) throw new Error('HTTP '+r.status);
  } catch (e) {
    console.warn('Rescan joystick failed', e);
  }
});
        // Slider event listeners
        document.getElementById('panOffset').addEventListener('input', function() {
            const value = parseFloat(this.value);
            document.getElementById('panValue').textContent = value.toFixed(2);
            sendPanOffset(value);
        });
        
        document.getElementById('tiltOffset').addEventListener('input', function() {
            const value = parseFloat(this.value);
            document.getElementById('tiltValue').textContent = value.toFixed(2);
            sendTiltOffset(value);
        });
        
        // Direct axis controls - avec protection contre les boucles
        document.getElementById('axisPan').addEventListener('input', function() {
            if (!isUpdatingFromServer) {
                const value = parseFloat(this.value);
                document.getElementById('axisPanValue').textContent = value.toFixed(2);
                sendAxisPan(value);
            }
        });
        
        document.getElementById('axisTilt').addEventListener('input', function() {
            if (!isUpdatingFromServer) {
                const value = parseFloat(this.value);
                document.getElementById('axisTiltValue').textContent = value.toFixed(2);
                sendAxisTilt(value);
            }
        });
        
        document.getElementById('axisZoom').addEventListener('input', function() {
            if (!isUpdatingFromServer) {
                const value = parseFloat(this.value);
                document.getElementById('axisZoomValue').textContent = value.toFixed(2);
                sendAxisZoom(value);
            }
        });
        
        document.getElementById('axisSlide').addEventListener('input', function() {
            if (!isUpdatingFromServer) {
                const value = parseFloat(this.value);
                document.getElementById('axisSlideValue').textContent = value.toFixed(2);
                sendAxisSlide(value);
            }
        });
        
        // API Functions
        function sendPanOffset(value) {
            fetch('/api/joystick/pan', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({value: value})
            });
        }
        
        function sendTiltOffset(value) {
            fetch('/api/joystick/tilt', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({value: value})
            });
        }
        
        function sendJoystickCombined(pan, tilt) {
            fetch('/api/joystick/combined', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({pan: pan, tilt: tilt})
            });
        }
        
        function configureJoystick(deadzone, expo, slew, filter_hz, pan_tilt_speed, slide_speed) {
            fetch('/api/joystick/config', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    deadzone: deadzone,
                    expo: expo,
                    slew: slew,
                    filter_hz: filter_hz,
                    pan_tilt_speed: pan_tilt_speed,
                    slide_speed: slide_speed
                })
            });
        }
        
        function applyJoystickConfig() {
            const deadzone = parseFloat(document.getElementById('deadzone').value);
            const expo = parseFloat(document.getElementById('expo').value);
            const slew = parseFloat(document.getElementById('slew').value);
            const filterHz = parseFloat(document.getElementById('filterHz').value);
            const panTiltSpeed = parseFloat(document.getElementById('panTiltSpeed').value);
            const slideSpeed = parseFloat(document.getElementById('slideSpeed').value);
            
            configureJoystick(deadzone, expo, slew, filterHz, panTiltSpeed, slideSpeed);
            updateStatus('Joystick configuration applied');
        }
        
        function updateDeadzoneValue() {
            document.getElementById('deadzoneValue').textContent = document.getElementById('deadzone').value;
        }
        
        function updateExpoValue() {
            document.getElementById('expoValue').textContent = document.getElementById('expo').value;
        }
        
        function updateSlewValue() {
            document.getElementById('slewValue').textContent = document.getElementById('slew').value;
        }
        
        function updateFilterHzValue() {
            document.getElementById('filterHzValue').textContent = document.getElementById('filterHz').value;
        }
        
        function updatePanTiltSpeedValue() {
            const value = document.getElementById('panTiltSpeed').value;
            document.getElementById('panTiltSpeedValue').textContent = value + 'x';
        }
        
        function updateSlideSpeedValue() {
            const value = document.getElementById('slideSpeed').value;
            document.getElementById('slideSpeedValue').textContent = value + 'x';
        }
        
        function sendAxisPan(value) {
            fetch('/api/axis_pan', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({value: value})
            });
        }
        
        function sendAxisTilt(value) {
            fetch('/api/axis_tilt', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({value: value})
            });
        }
        
        function sendAxisZoom(value) {
            fetch('/api/axis_zoom', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({value: value})
            });
        }
        
        function sendAxisSlide(value) {
            fetch('/api/axis_slide', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({value: value})
            });
        }
        
        // Variables globales pour la gestion des √©tats
        let selectedPreset = null;
        let currentRecallingPreset = null;
        
        function selectPreset(presetId) {
            // D√©s√©lectionner tous les presets
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Nettoyer les √©tats des presets non-s√©lectionn√©s
            resetNonSelectedPresets();
            
            // S√©lectionner le preset cliqu√©
            const presetBtn = document.querySelector(`[data-preset="${presetId}"]`);
            presetBtn.classList.add('selected');
            selectedPreset = presetId;
            
            console.log(`Preset ${presetId} s√©lectionn√©`);
        }
        
        function resetNonSelectedPresets() {
            // Remettre en blanc tous les presets qui ne sont ni sauv√©s ni rappel√©s
            document.querySelectorAll('.preset-btn').forEach(btn => {
                if (!btn.classList.contains('saved') && !btn.classList.contains('recalled') && !btn.classList.contains('selected')) {
                    btn.classList.remove('saved', 'recalled', 'recalling');
                }
            });
        }
        
        function recallSelectedPreset() {
            if (selectedPreset === null) {
                alert('Veuillez d\'abord s√©lectionner un preset');
                return;
            }
            
            // D'abord, remettre tous les presets en blanc (sauf ceux sauv√©s)
            document.querySelectorAll('.preset-btn').forEach(btn => {
                if (!btn.classList.contains('saved')) {
                    btn.classList.remove('recalled', 'recalling');
                }
            });
            
            const duration = parseFloat(document.getElementById('presetDuration').value);
            const presetBtn = document.querySelector(`[data-preset="${selectedPreset}"]`);
            
            // √âtat: En cours de rappel (clignotant)
            presetBtn.classList.remove('selected', 'recalled');
            presetBtn.classList.add('recalling');
            currentRecallingPreset = selectedPreset;
            
            // Envoyer la commande de rappel
            fetch('/api/preset/recall', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({id: selectedPreset, duration: duration})
            }).then(response => {
                if (response.ok) {
                    // Simuler la dur√©e du rappel
                    setTimeout(() => {
                        presetBtn.classList.remove('recalling');
                        presetBtn.classList.add('recalled');
                        currentRecallingPreset = null;
                        console.log(`Preset ${selectedPreset} rappel√© avec succ√®s`);
                    }, duration * 1000);
                } else {
                    // En cas d'erreur, revenir √† l'√©tat s√©lectionn√©
                    presetBtn.classList.remove('recalling');
                    presetBtn.classList.add('selected');
                    currentRecallingPreset = null;
                    alert('Erreur lors du rappel du preset');
                }
            });
        }

        // Store des positions r√©elles dans le preset s√©lectionn√©
        function storeRealPreset() {
            if (selectedPreset === null) { alert('S√©lectionne un preset'); return; }
            fetch('/api/preset/store', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ id: selectedPreset })
            });
        }

        
        
        
        function resetOffsets() {
            document.getElementById('panOffset').value = 0;
            document.getElementById('tiltOffset').value = 0;
            document.getElementById('panValue').textContent = '0.00';
            document.getElementById('tiltValue').textContent = '0.00';
            sendPanOffset(0);
            sendTiltOffset(0);
        }
        
        function applyConfig() {
            const panRange = parseInt(document.getElementById('panRange').value);
            const tiltRange = parseInt(document.getElementById('tiltRange').value);
            const panMapMin = parseInt(document.getElementById('panMapMin').value);
            const panMapMax = parseInt(document.getElementById('panMapMax').value);
            const tiltMapMin = parseInt(document.getElementById('tiltMapMin').value);
            const tiltMapMax = parseInt(document.getElementById('tiltMapMax').value);
            
            fetch('/api/config/offset_range', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({pan_range: panRange, tilt_range: tiltRange})
            });
            
            fetch('/api/config/pan_map', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({min: panMapMin, max: panMapMax})
            });
            
            fetch('/api/config/tilt_map', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({min: tiltMapMin, max: tiltMapMax})
            });
        }
        
        // Interpolation Axis functions
        let interpPointCount = 2;  // Commence avec 2 points (A et B)
        const maxInterpPoints = 6;

        function addInterpPoint() {
            if (interpPointCount >= maxInterpPoints) return;
            
            const extraContainer = document.getElementById('extraInterpPoints');
            const pointLabel = String.fromCharCode(65 + interpPointCount);  // C, D, E, F
            
            const pointDiv = document.createElement('div');
            pointDiv.className = 'control-group';
            pointDiv.id = `interpPoint${interpPointCount}`;
            pointDiv.innerHTML = `
                <label>Point ${pointLabel}:</label>
                <select id="interpPreset${interpPointCount}">
                    <option value="0">Preset 0</option>
                    <option value="1">Preset 1</option>
                    <option value="2">Preset 2</option>
                    <option value="3">Preset 3</option>
                    <option value="4">Preset 4</option>
                    <option value="5">Preset 5</option>
                    <option value="6">Preset 6</option>
                    <option value="7">Preset 7</option>
                </select>
                <span>@</span>
                <input type="number" id="interpPos${interpPointCount}" min="0" max="100" step="1" value="50" style="width: 60px;">
                <span>%</span>
                <button onclick="removeInterpPoint(${interpPointCount})" class="btn-danger" style="margin-left: 10px;">‚úñÔ∏è</button>
            `;
            
            extraContainer.appendChild(pointDiv);
            interpPointCount++;
            
            // Utiliser la fonction centralis√©e pour mettre √† jour le bouton
            updateAddPointButton();
        }

        function removeInterpPoint(index) {
            const pointDiv = document.getElementById(`interpPoint${index}`);
            if (pointDiv) {
                pointDiv.remove();
                interpPointCount--;
                
                // Utiliser la fonction centralis√©e pour mettre √† jour le bouton
                updateAddPointButton();
            }
        }

        function applyInterpPoints() {
            const points = [];
            
            // Collecter tous les points d√©finis
            for (let i = 0; i < 2; i++) {  // Points fixes A et B
                const preset = parseInt(document.getElementById(`interpPreset${i}`).value);
                const position = parseFloat(document.getElementById(`interpPos${i}`).value) / 100.0;
                points.push({preset: preset, position: position});
            }
            
            // Points additionnels
            for (let i = 2; i < 6; i++) {
                const presetEl = document.getElementById(`interpPreset${i}`);
                if (presetEl) {
                    const preset = parseInt(presetEl.value);
                    const position = parseFloat(document.getElementById(`interpPos${i}`).value) / 100.0;
                    points.push({preset: preset, position: position});
                }
            }
            
            // Trier par position
            points.sort((a, b) => a.position - b.position);
            
            fetch('/api/interpolation/setpoints', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({points: points})
            });
        }

        function toggleInterpMode() {
            const mode = document.getElementById('interpMode').value;
            
            if (mode === 'auto') {
                document.getElementById('manualControls').style.display = 'none';
                document.getElementById('autoControls').style.display = 'block';
            } else {
                document.getElementById('manualControls').style.display = 'block';
                document.getElementById('autoControls').style.display = 'none';
                // Arr√™ter le mode auto si actif
                stopAutoMorphing();
            }
        }

        function updateInterpJogValue() {
            const slider = document.getElementById('interpJogSlider');
            const value = parseFloat(slider.value);
            
            // Afficher la valeur avec 2 d√©cimales
            document.getElementById('interpJogValue').textContent = value.toFixed(2);
            
            // Envoyer la consigne de vitesse en temps r√©el au contr√¥leur
            fetch('/api/interpolation/jog', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({value: value})
            });
        }

        function resetInterpJog() {
            const slider = document.getElementById('interpJogSlider');
            slider.value = 0;
            document.getElementById('interpJogValue').textContent = '0.00';
            
            // Envoyer la commande reset (vitesse 0)
            fetch('/api/interpolation/jog', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({value: 0})
            });
        }

        function startAutoMorphing() {
            const duration = parseFloat(document.getElementById('interpAutoDuration').value);
            
            fetch('/api/interpolation/auto', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({enable: true, duration: duration})
            });
        }

        function stopAutoMorphing() {
            fetch('/api/interpolation/auto', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({enable: false, duration: 0})
            });
        }

        // Motor Configuration functions
        function updatePanSpeed() {
            const speed = parseInt(document.getElementById('panMaxSpeed').value);
            document.getElementById('panSpeedValue').textContent = speed;
            
            fetch('/api/motor/pan/max_speed', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({speed: speed})
            });
        }

        function updatePanAccel() {
            const accel = parseInt(document.getElementById('panMaxAccel').value);
            document.getElementById('panAccelValue').textContent = accel;
            
            fetch('/api/motor/pan/max_accel', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({accel: accel})
            });
        }

        function updateTiltSpeed() {
            const speed = parseInt(document.getElementById('tiltMaxSpeed').value);
            document.getElementById('tiltSpeedValue').textContent = speed;
            
            fetch('/api/motor/tilt/max_speed', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({speed: speed})
            });
        }

        function updateTiltAccel() {
            const accel = parseInt(document.getElementById('tiltMaxAccel').value);
            document.getElementById('tiltAccelValue').textContent = accel;
            
            fetch('/api/motor/tilt/max_accel', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({accel: accel})
            });
        }

        function updateZoomSpeed() {
            const speed = parseInt(document.getElementById('zoomMaxSpeed').value);
            document.getElementById('zoomSpeedValue').textContent = speed;
            
            fetch('/api/motor/zoom/max_speed', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({speed: speed})
            });
        }

        function updateZoomAccel() {
            const accel = parseInt(document.getElementById('zoomMaxAccel').value);
            document.getElementById('zoomAccelValue').textContent = accel;
            
            fetch('/api/motor/zoom/max_accel', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({accel: accel})
            });
        }

        function updateSlideSpeed() {
            const speed = parseInt(document.getElementById('slideMaxSpeed').value);
            document.getElementById('slideSpeedValue').textContent = speed;
            
            fetch('/api/motor/slide/max_speed', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({speed: speed})
            });
        }

        function updateSlideAccel() {
            const accel = parseInt(document.getElementById('slideMaxAccel').value);
            document.getElementById('slideAccelValue').textContent = accel;
            
            fetch('/api/motor/slide/max_accel', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({accel: accel})
            });
        }

        function homeSlide() {
            fetch('/api/slide/home', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({})
            });
        }

        function updateSGTHRS() {
            const value = parseInt(document.getElementById('sgthrsRange').value);
            document.getElementById('sgthrsVal').textContent = value;
            
            fetch('/api/slide/sgthrs', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({threshold: value})
            });
        }

        // Bank Management functions
        function openBank() {
            const bankIndex = parseInt(document.getElementById('bankSelector').value);
            
            fetch('/api/bank/set', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({index: bankIndex})
            }).then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('bankStatus').textContent = `Bank ${bankIndex} loaded`;
                    document.getElementById('bankStatus').style.color = '#4CAF50';
                    
                    // Sauvegarder la banque active dans localStorage
                    localStorage.setItem('activeBank', bankIndex);
                    
                    // Mettre √† jour les points d'interpolation si disponibles
                    if (data.interp && data.interpCount) {
                        updateInterpolationUI(data.interpCount, data.interp);
                        
                        // Mettre √† jour le compteur et le bouton Add Point
                        interpPointCount = data.interpCount;
                        updateAddPointButton();
                    }
                } else {
                    document.getElementById('bankStatus').textContent = 'Error loading bank';
                    document.getElementById('bankStatus').style.color = '#f44336';
                }
            });
        }

        // Fonction pour mettre √† jour le bouton Add Point
        function updateAddPointButton() {
            const btn = document.getElementById('addPointBtn');
            if (btn) {
                btn.textContent = `+ Add Point (${interpPointCount}/${maxInterpPoints})`;
                btn.disabled = (interpPointCount >= maxInterpPoints);
            }
        }

        // Fonction pour mettre √† jour l'interface d'interpolation
        function updateInterpolationUI(interpCount, interpPoints) {
            // Vider le conteneur des points suppl√©mentaires
            const extraContainer = document.getElementById('extraInterpPoints');
            if (extraContainer) {
                extraContainer.innerHTML = '';
            }
            
            // Mettre √† jour les points existants (0 et 1)
            if (interpPoints.length > 0) {
                const preset0 = document.getElementById('interpPreset0');
                const pos0 = document.getElementById('interpPos0');
                if (preset0 && pos0) {
                    preset0.value = interpPoints[0].presetIndex;
                    pos0.value = interpPoints[0].fraction;
                }
            }
            
            if (interpPoints.length > 1) {
                const preset1 = document.getElementById('interpPreset1');
                const pos1 = document.getElementById('interpPos1');
                if (preset1 && pos1) {
                    preset1.value = interpPoints[1].presetIndex;
                    pos1.value = interpPoints[1].fraction;
                }
            }
            
            // Cr√©er directement les points suppl√©mentaires (2 et plus) sans utiliser addInterpPoint()
            for (let i = 2; i < interpCount; i++) {
                if (i < interpPoints.length) {
                    const pointLabel = String.fromCharCode(65 + i);  // C, D, E, F
                    
                    const pointDiv = document.createElement('div');
                    pointDiv.className = 'control-group';
                    pointDiv.id = `interpPoint${i}`;
                    pointDiv.innerHTML = `
                        <label>Point ${pointLabel}:</label>
                        <select id="interpPreset${i}">
                            <option value="0">Preset 0</option>
                            <option value="1">Preset 1</option>
                            <option value="2">Preset 2</option>
                            <option value="3">Preset 3</option>
                            <option value="4">Preset 4</option>
                            <option value="5">Preset 5</option>
                            <option value="6">Preset 6</option>
                            <option value="7">Preset 7</option>
                        </select>
                        <span>@</span>
                        <input type="number" id="interpPos${i}" min="0" max="100" step="1" value="50" style="width: 60px;">
                        <span>%</span>
                        <button onclick="removeInterpPoint(${i})" class="btn-danger" style="margin-left: 10px;">‚úñÔ∏è</button>
                    `;
                    
                    extraContainer.appendChild(pointDiv);
                    
                    // Remplir les valeurs
                    const presetField = document.getElementById(`interpPreset${i}`);
                    const posField = document.getElementById(`interpPos${i}`);
                    if (presetField && posField) {
                        presetField.value = interpPoints[i].presetIndex;
                        posField.value = interpPoints[i].fraction;
                    }
                }
            }
            
            console.log(`Updated interpolation UI with ${interpCount} points`);
        }

        function saveBank() {
            document.getElementById('bankStatus').textContent = 'Saving...';
            document.getElementById('bankStatus').style.color = '#ff9800';
            
            fetch('/api/bank/save', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({})
            }).then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('bankStatus').textContent = 'Bank saved!';
                    document.getElementById('bankStatus').style.color = '#4CAF50';
                } else {
                    document.getElementById('bankStatus').textContent = 'Error saving bank';
                    document.getElementById('bankStatus').style.color = '#f44336';
                }
            });
        }

        // Initialize display values
        document.getElementById('panValue').textContent = '0.00';
        document.getElementById('tiltValue').textContent = '0.00';
        document.getElementById('axisPanValue').textContent = '0.50';
        document.getElementById('axisTiltValue').textContent = '0.50';
        document.getElementById('axisZoomValue').textContent = '0.50';
        document.getElementById('axisSlideValue').textContent = '0.50';
        document.getElementById('interpJogValue').textContent = '0.00';
        
        // Initialiser la banque active depuis localStorage
        const savedBank = localStorage.getItem('activeBank');
        if (savedBank !== null) {
            document.getElementById('bankSelector').value = savedBank;
        }
        
        //==================== Joystick Canvas ====================
        const joyCanvas = document.getElementById('joyCanvas');
        const joyCtx = joyCanvas.getContext('2d');
        const JOY_R = Math.min(joyCanvas.width, joyCanvas.height) * 0.45;

        function drawJoy(x, y) {
            const cx = joyCanvas.width / 2;
            const cy = joyCanvas.height / 2;

            joyCtx.clearRect(0,0,joyCanvas.width,joyCanvas.height);

            // cercle ext√©rieur
            joyCtx.beginPath();
            joyCtx.arc(cx, cy, JOY_R, 0, Math.PI*2);
            joyCtx.lineWidth = 2;
            joyCtx.strokeStyle = '#6c757d';
            joyCtx.stroke();

            // croix centrale
            joyCtx.beginPath(); 
            joyCtx.moveTo(cx - JOY_R, cy); 
            joyCtx.lineTo(cx + JOY_R, cy); 
            joyCtx.stroke();
            joyCtx.beginPath(); 
            joyCtx.moveTo(cx, cy - JOY_R); 
            joyCtx.lineTo(cx, cy + JOY_R); 
            joyCtx.stroke();

            // point (x,y) -> pixel
            const px = cx + x * JOY_R;
            const py = cy - y * JOY_R;

            // cercle du point
            joyCtx.beginPath();
            joyCtx.arc(px, py, 8, 0, Math.PI*2);
            joyCtx.fillStyle = '#007bff';
            joyCtx.fill();
        }

        async function pollJoystick() {
            try {
                const r = await fetch('/api/joystick/state');
                if (!r.ok) throw new Error('HTTP '+r.status);
                const js = await r.json();

                const x = (js.x ?? 0);
                const y = (js.y ?? 0);
                drawJoy(x, y);

                document.getElementById('joyX').textContent = x.toFixed(2);
                document.getElementById('joyY').textContent = y.toFixed(2);

                const conn = !!js.connected;
                document.body.dataset.joy = conn ? 'connected' : 'disconnected';
                document.getElementById('joyHint').textContent =
                    conn ? (js.name ? `‚úÖ ${js.name}` : '‚úÖ Joystick connect√©') : '‚ùå Aucun joystick d√©tect√© (les faders restent actifs).';
            } catch (e) {
                // En cas d'erreur, on laisse les faders visibles
                document.body.dataset.joy = 'disconnected';
            } finally {
                // ~30 FPS UI
                setTimeout(pollJoystick, 33);
            }
        }
        //==================== Homing handlers ====================
        const sgInput = document.getElementById('sgthrsRange');
        const sgVal   = document.getElementById('sgthrsVal');
        if (sgInput && sgVal) {
            sgInput.addEventListener('input', () => {
                sgVal.textContent = String(parseInt(sgInput.value, 10));
            });
            sgInput.addEventListener('change', () => {
                const v = parseInt(sgInput.value, 10) || 8;
                fetch('/api/slide/sgthrs', {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ value: v })
                });
            });
        }
        const btnHome = document.getElementById('btnSlideHome');
        if (btnHome) {
            btnHome.addEventListener('click', () => {
                fetch('/api/slide/home', { method: 'POST' });
            });
        }

        pollJoystick();
        
        // Polling des positions des moteurs en temps r√©el
        function pollMotorPositions() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    if (data.motors) {
                        updateMotorDisplays(data);
                    }
                })
                .catch(error => {
                    console.log('Erreur polling moteurs:', error);
                });
        }
        
        function updateMotorDisplays(data) {
            // Mettre √† jour les affichages des positions
            const motors = data.motors;
            const motorsPercent = data.motors_percent;
            
            // Mettre √† jour les sliders "Direct Axis" avec les positions actuelles
            updateDirectAxisSlider('axisPan', motors.pan, motorsPercent.pan);
            updateDirectAxisSlider('axisTilt', motors.tilt, motorsPercent.tilt);
            updateDirectAxisSlider('axisZoom', motors.zoom, motorsPercent.zoom);
            updateDirectAxisSlider('axisSlide', motors.slide, motorsPercent.slide);
            
            // Mettre √† jour l'√©tat des modes
            updateModeStatus(data.modes);
        }
        
        // Variable pour √©viter les boucles lors de la mise √† jour automatique
        let isUpdatingFromServer = false;
        
        function updateDirectAxisSlider(axis, position, percent) {
            const slider = document.getElementById(`${axis}Slider`);
            const valueDisplay = document.getElementById(`${axis}Value`);
            
            if (slider && valueDisplay) {
                // Marquer qu'on est en train de mettre √† jour depuis le serveur
                isUpdatingFromServer = true;
                
                // Convertir le pourcentage (0-100) en valeur de slider (0-1)
                const sliderValue = percent / 100.0;
                slider.value = Math.max(0, Math.min(1, sliderValue));
                valueDisplay.textContent = sliderValue.toFixed(2);
                
                // R√©initialiser le flag apr√®s un court d√©lai
                setTimeout(() => {
                    isUpdatingFromServer = false;
                }, 100);
            }
        }
        
        
        function updateModeStatus(modes) {
            // Mettre √† jour l'affichage des modes actifs
            const statusElements = {
                'interpAuto': document.getElementById('interpAutoStatus'),
                'syncMove': document.getElementById('syncMoveStatus'),
                'slideAB': document.getElementById('slideABStatus'),
                'follow': document.getElementById('followStatus')
            };
            
            for (const [mode, element] of Object.entries(statusElements)) {
                if (element) {
                    element.textContent = modes[mode] ? 'üü¢ Actif' : '‚ö™ Inactif';
                    element.style.color = modes[mode] ? '#4CAF50' : '#666';
                }
            }
        }
        
        // D√©marrer le polling des positions (toutes les 500ms)
        setInterval(pollMotorPositions, 500);
        
        // Polling initial
        pollMotorPositions();
        
        // Initialiser le bouton Add Point au chargement de la page
        updateAddPointButton();
    </script>
</body>
</html>

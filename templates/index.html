<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Slider Controller</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .status {
            text-align: center;
            margin-bottom: 30px;
            padding: 15px;
            border-radius: 10px;
            background: #f8f9fa;
            border-left: 4px solid #28a745;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .control-panel {
            background: #fff;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid #e9ecef;
        }

        .control-panel h3 {
            color: #495057;
            margin-bottom: 20px;
            font-size: 1.3em;
            text-align: center;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
        }

        .slider-container {
            margin-bottom: 20px;
        }

        .slider-container label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .slider {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #007bff;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 123, 255, 0.3);
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #007bff;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0, 123, 255, 0.3);
        }

        .value-display {
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            color: #007bff;
            margin-top: 10px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #1e7e34;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }

        .preset-controls {
            grid-column: 1 / -1;
        }

        .preset-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .preset-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #e9ecef;
        }

        .preset-panel h4 {
            color: #495057;
            margin-bottom: 15px;
            text-align: center;
        }

        .preset-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .preset-input {
            display: flex;
            flex-direction: column;
        }

        .preset-input label {
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .preset-input input {
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 14px;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 25px;
            color: white;
            font-weight: bold;
            z-index: 1000;
        }

        .status-connected {
            background: #28a745;
        }

        .status-disconnected {
            background: #dc3545;
        }

        /* Joystick styles */
        .joy-flex {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .joy-visual {
            text-align: center;
        }

        .joystick {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            border: 2px solid #e9ecef;
        }

        .joystick h4 {
            margin-bottom: 10px;
            color: #495057;
        }

        #joyCanvas {
            border: 2px solid #007bff;
            border-radius: 10px;
            background: #fff;
            cursor: crosshair;
        }

        .hint {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .preset-grid {
                grid-template-columns: 1fr;
            }
            
            .preset-inputs {
                grid-template-columns: 1fr;
            }
            
            .joy-flex {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">
        Connecting...
    </div>

    <div class="container">
        <h1>üé¨ ESP32 Slider Controller</h1>
        
        <div class="status">
            <strong>Status:</strong> <span id="statusText">Ready to control your slider</span>
        </div>

        <div class="controls-grid">
            <!-- Jog Control -->
            <div class="control-panel">
                <h3>üéÆ Jog Control</h3>
                <div class="slider-container">
                    <label for="jogSlider">Movement Speed (-1.0 to 1.0)</label>
                    <input type="range" id="jogSlider" class="slider" min="-1" max="1" step="0.01" value="0">
                    <div class="value-display" id="jogValue">0.00</div>
                </div>
                <div class="button-group">
                    <button class="btn btn-danger" onclick="stopMovement()">üõë Stop</button>
                </div>
            </div>

            <!-- Joystick Control -->
            <div class="control-panel">
                <h3>üéÆ Joystick Controls</h3>
                
                <div class="joy-flex">
                    <div class="joy-visual">
                        <canvas id="joyCanvas" width="180" height="180"></canvas>
                        <div class="value-display">X: <span id="joyX">0.00</span> | Y: <span id="joyY">0.00</span></div>
                        <div id="joyHint" class="hint">Recherche d'un joystick USB‚Ä¶</div>
                        <button class="btn btn-primary" id="joyReconnectBtn" title="Rescanner le joystick" style="margin-top:8px">üîÅ Reconnect Joystick</button>
                    </div>

                    <!-- Fallback sliders (cach√©s si joystick connect√©) -->
                    <div id="sliderJoystickGroup">
                        <div class="joystick">
                            <h4>Pan Offset</h4>
                            <input type="range" class="slider" id="panOffset" min="-1" max="1" step="0.01" value="0">
                            <div class="value-display" id="panOffsetValue">0.00</div>
                        </div>
                        <div class="joystick">
                            <h4>Tilt Offset</h4>
                            <input type="range" class="slider" id="tiltOffset" min="-1" max="1" step="0.01" value="0">
                            <div class="value-display" id="tiltOffsetValue">0.00</div>
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-warning" onclick="resetJoystickOffsets()">üîÑ Reset Offsets</button>
                </div>
            </div>

            <!-- Pan Control -->
            <div class="control-panel">
                <h3>‚ÜîÔ∏è Pan Control</h3>
                <div class="slider-container">
                    <label for="panSlider">Pan Offset (-1.0 to 1.0)</label>
                    <input type="range" id="panSlider" class="slider" min="-1" max="1" step="0.01" value="0">
                    <div class="value-display" id="panValue">0.00</div>
                </div>
                <div class="button-group">
                    <button class="btn btn-warning" onclick="resetPan()">üîÑ Reset</button>
                </div>
            </div>

            <!-- Tilt Control -->
            <div class="control-panel">
                <h3>‚ÜïÔ∏è Tilt Control</h3>
                <div class="slider-container">
                    <label for="tiltSlider">Tilt Offset (-1.0 to 1.0)</label>
                    <input type="range" id="tiltSlider" class="slider" min="-1" max="1" step="0.01" value="0">
                    <div class="value-display" id="tiltValue">0.00</div>
                </div>
                <div class="button-group">
                    <button class="btn btn-warning" onclick="resetTilt()">üîÑ Reset</button>
                </div>
            </div>

            <!-- Direct Axis Control -->
            <div class="control-panel">
                <h3>üéØ Pan Direct</h3>
                <div class="slider-container">
                    <label for="axisPanSlider">Pan Position (0.0 to 1.0)</label>
                    <input type="range" id="axisPanSlider" class="slider" min="0" max="1" step="0.01" value="0.5">
                    <div class="value-display" id="axisPanValue">0.50</div>
                </div>
                <div class="button-group">
                    <button class="btn btn-warning" onclick="resetAxisPan()">üîÑ Center</button>
                </div>
            </div>

            <div class="control-panel">
                <h3>üéØ Tilt Direct</h3>
                <div class="slider-container">
                    <label for="axisTiltSlider">Tilt Position (0.0 to 1.0)</label>
                    <input type="range" id="axisTiltSlider" class="slider" min="0" max="1" step="0.01" value="0.5">
                    <div class="value-display" id="axisTiltValue">0.50</div>
                </div>
                <div class="button-group">
                    <button class="btn btn-warning" onclick="resetAxisTilt()">üîÑ Center</button>
                </div>
            </div>

            <div class="control-panel">
                <h3>üéØ Zoom Direct</h3>
                <div class="slider-container">
                    <label for="axisZoomSlider">Zoom Position (0.0 to 1.0)</label>
                    <input type="range" id="axisZoomSlider" class="slider" min="0" max="1" step="0.01" value="0.5">
                    <div class="value-display" id="axisZoomValue">0.50</div>
                </div>
                <div class="button-group">
                    <button class="btn btn-warning" onclick="resetAxisZoom()">üîÑ Center</button>
                </div>
            </div>

            <div class="control-panel">
                <h3>üéØ Slide Direct</h3>
                <div class="slider-container">
                    <label for="axisSlideSlider">Slide Position (0.0 to 1.0)</label>
                    <input type="range" id="axisSlideSlider" class="slider" min="0" max="1" step="0.01" value="0.5">
                    <div class="value-display" id="axisSlideValue">0.50</div>
                </div>
                <div class="button-group">
                    <button class="btn btn-warning" onclick="resetAxisSlide()">üîÑ Center</button>
                </div>
            </div>

            <!-- Preset Controls -->
            <div class="control-panel preset-controls">
                <h3>üìç Preset Management</h3>
                <div class="preset-grid">
                    <div class="preset-panel">
                        <h4>Preset A</h4>
                        <div class="preset-inputs">
                            <div class="preset-input">
                                <label>Pan (steps)</label>
                                <input type="number" id="presetA_pan" value="0">
                            </div>
                            <div class="preset-input">
                                <label>Tilt (steps)</label>
                                <input type="number" id="presetA_tilt" value="0">
                            </div>
                            <div class="preset-input">
                                <label>Zoom (steps)</label>
                                <input type="number" id="presetA_zoom" value="0">
                            </div>
                            <div class="preset-input">
                                <label>Slide (steps)</label>
                                <input type="number" id="presetA_slide" value="0">
                            </div>
                        </div>
                        <div class="button-group">
                            <button class="btn btn-primary" onclick="setPresetA()">Set Preset A</button>
                        </div>
                    </div>

                    <div class="preset-panel">
                        <h4>Preset B</h4>
                        <div class="preset-inputs">
                            <div class="preset-input">
                                <label>Pan (steps)</label>
                                <input type="number" id="presetB_pan" value="0">
                            </div>
                            <div class="preset-input">
                                <label>Tilt (steps)</label>
                                <input type="number" id="presetB_tilt" value="0">
                            </div>
                            <div class="preset-input">
                                <label>Zoom (steps)</label>
                                <input type="number" id="presetB_zoom" value="0">
                            </div>
                            <div class="preset-input">
                                <label>Slide (steps)</label>
                                <input type="number" id="presetB_slide" value="0">
                            </div>
                        </div>
                        <div class="button-group">
                            <button class="btn btn-primary" onclick="setPresetB()">Set Preset B</button>
                        </div>
                    </div>
                </div>
                <div class="button-group" style="margin-top: 20px;">
                    <button class="btn btn-danger" onclick="resetAllAxes()">üîÑ Reset All Axes to Center</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let isConnected = false;
        let lastJogValue = 0;

        // Initialize the interface
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing interface...');
            setupSliders();
            setupJoystick();
            checkConnection();
            updateConnectionStatus();
        });

        function setupSliders() {
            // Jog slider
            const jogSlider = document.getElementById('jogSlider');
            const jogValue = document.getElementById('jogValue');
            
            jogSlider.addEventListener('input', function() {
                const value = parseFloat(this.value);
                jogValue.textContent = value.toFixed(2);
                sendJogCommand(value);
            });

            // Pan slider
            const panSlider = document.getElementById('panSlider');
            const panValue = document.getElementById('panValue');
            
            panSlider.addEventListener('input', function() {
                const value = parseFloat(this.value);
                panValue.textContent = value.toFixed(2);
                sendPanCommand(value);
            });

            // Tilt slider
            const tiltSlider = document.getElementById('tiltSlider');
            const tiltValue = document.getElementById('tiltValue');
            
            tiltSlider.addEventListener('input', function() {
                const value = parseFloat(this.value);
                tiltValue.textContent = value.toFixed(2);
                sendTiltCommand(value);
            });

            // Direct axis sliders
            const axisPanSlider = document.getElementById('axisPanSlider');
            const axisPanValue = document.getElementById('axisPanValue');
            
            axisPanSlider.addEventListener('input', function() {
                const value = parseFloat(this.value);
                axisPanValue.textContent = value.toFixed(2);
                sendAxisPanCommand(value);
            });

            const axisTiltSlider = document.getElementById('axisTiltSlider');
            const axisTiltValue = document.getElementById('axisTiltValue');
            
            axisTiltSlider.addEventListener('input', function() {
                const value = parseFloat(this.value);
                axisTiltValue.textContent = value.toFixed(2);
                sendAxisTiltCommand(value);
            });

            const axisZoomSlider = document.getElementById('axisZoomSlider');
            const axisZoomValue = document.getElementById('axisZoomValue');
            
            axisZoomSlider.addEventListener('input', function() {
                const value = parseFloat(this.value);
                axisZoomValue.textContent = value.toFixed(2);
                sendAxisZoomCommand(value);
            });

            const axisSlideSlider = document.getElementById('axisSlideSlider');
            const axisSlideValue = document.getElementById('axisSlideValue');
            
            axisSlideSlider.addEventListener('input', function() {
                const value = parseFloat(this.value);
                axisSlideValue.textContent = value.toFixed(2);
                sendAxisSlideCommand(value);
            });
        }

        // API Functions
        async function sendJogCommand(value) {
            try {
                const response = await fetch('/api/jog', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({value: value})
                });
                const result = await response.json();
                updateStatus(`Jog: ${value.toFixed(2)}`);
                isConnected = true;
            } catch (error) {
                console.error('Jog command failed:', error);
                isConnected = false;
            }
            updateConnectionStatus();
        }

        async function sendPanCommand(value) {
            try {
                const response = await fetch('/api/pan', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({value: value})
                });
                const result = await response.json();
                updateStatus(`Pan: ${value.toFixed(2)}`);
                isConnected = true;
            } catch (error) {
                console.error('Pan command failed:', error);
                isConnected = false;
            }
            updateConnectionStatus();
        }

        async function sendTiltCommand(value) {
            try {
                const response = await fetch('/api/tilt', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({value: value})
                });
                const result = await response.json();
                updateStatus(`Tilt: ${value.toFixed(2)}`);
                isConnected = true;
            } catch (error) {
                console.error('Tilt command failed:', error);
                isConnected = false;
            }
            updateConnectionStatus();
        }

        async function setPresetA() {
            const pan = parseInt(document.getElementById('presetA_pan').value);
            const tilt = parseInt(document.getElementById('presetA_tilt').value);
            const zoom = parseInt(document.getElementById('presetA_zoom').value);
            const slide = parseInt(document.getElementById('presetA_slide').value);

            try {
                const response = await fetch('/api/preset_a', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({pan, tilt, zoom, slide})
                });
                const result = await response.json();
                updateStatus(`Preset A set: P${pan} T${tilt} Z${zoom} S${slide}`);
                isConnected = true;
            } catch (error) {
                console.error('Preset A command failed:', error);
                isConnected = false;
            }
            updateConnectionStatus();
        }

        async function setPresetB() {
            const pan = parseInt(document.getElementById('presetB_pan').value);
            const tilt = parseInt(document.getElementById('presetB_tilt').value);
            const zoom = parseInt(document.getElementById('presetB_zoom').value);
            const slide = parseInt(document.getElementById('presetB_slide').value);

            try {
                const response = await fetch('/api/preset_b', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({pan, tilt, zoom, slide})
                });
                const result = await response.json();
                updateStatus(`Preset B set: P${pan} T${tilt} Z${zoom} S${slide}`);
                isConnected = true;
            } catch (error) {
                console.error('Preset B command failed:', error);
                isConnected = false;
            }
            updateConnectionStatus();
        }

        async function stopMovement() {
            try {
                const response = await fetch('/api/stop', {method: 'POST'});
                const result = await response.json();
                document.getElementById('jogSlider').value = 0;
                document.getElementById('jogValue').textContent = '0.00';
                updateStatus('Movement stopped');
                isConnected = true;
            } catch (error) {
                console.error('Stop command failed:', error);
                isConnected = false;
            }
            updateConnectionStatus();
        }

        async function resetPan() {
            document.getElementById('panSlider').value = 0;
            document.getElementById('panValue').textContent = '0.00';
            await sendPanCommand(0);
        }

        async function resetTilt() {
            document.getElementById('tiltSlider').value = 0;
            document.getElementById('tiltValue').textContent = '0.00';
            await sendTiltCommand(0);
        }

        // Direct axis API functions
        async function sendAxisPanCommand(value) {
            try {
                const response = await fetch('/api/axis_pan', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({value: value})
                });
                const result = await response.json();
                updateStatus(`Pan Axis: ${value.toFixed(2)}`);
                isConnected = true;
            } catch (error) {
                console.error('Pan axis command failed:', error);
                isConnected = false;
            }
            updateConnectionStatus();
        }

        async function sendAxisTiltCommand(value) {
            try {
                const response = await fetch('/api/axis_tilt', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({value: value})
                });
                const result = await response.json();
                updateStatus(`Tilt Axis: ${value.toFixed(2)}`);
                isConnected = true;
            } catch (error) {
                console.error('Tilt axis command failed:', error);
                isConnected = false;
            }
            updateConnectionStatus();
        }

        async function sendAxisZoomCommand(value) {
            try {
                const response = await fetch('/api/axis_zoom', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({value: value})
                });
                const result = await response.json();
                updateStatus(`Zoom Axis: ${value.toFixed(2)}`);
                isConnected = true;
            } catch (error) {
                console.error('Zoom axis command failed:', error);
                isConnected = false;
            }
            updateConnectionStatus();
        }

        async function sendAxisSlideCommand(value) {
            try {
                const response = await fetch('/api/axis_slide', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({value: value})
                });
                const result = await response.json();
                updateStatus(`Slide Axis: ${value.toFixed(2)}`);
                isConnected = true;
            } catch (error) {
                console.error('Slide axis command failed:', error);
                isConnected = false;
            }
            updateConnectionStatus();
        }

        // Reset functions for direct axes
        async function resetAxisPan() {
            document.getElementById('axisPanSlider').value = 0.5;
            document.getElementById('axisPanValue').textContent = '0.50';
            await sendAxisPanCommand(0.5);
        }

        async function resetAxisTilt() {
            document.getElementById('axisTiltSlider').value = 0.5;
            document.getElementById('axisTiltValue').textContent = '0.50';
            await sendAxisTiltCommand(0.5);
        }

        async function resetAxisZoom() {
            document.getElementById('axisZoomSlider').value = 0.5;
            document.getElementById('axisZoomValue').textContent = '0.50';
            await sendAxisZoomCommand(0.5);
        }

        async function resetAxisSlide() {
            document.getElementById('axisSlideSlider').value = 0.5;
            document.getElementById('axisSlideValue').textContent = '0.50';
            await sendAxisSlideCommand(0.5);
        }

        async function resetAllAxes() {
            try {
                const response = await fetch('/api/reset_all_axes', {method: 'POST'});
                const result = await response.json();
                
                // Reset all sliders to center
                document.getElementById('axisPanSlider').value = 0.5;
                document.getElementById('axisPanValue').textContent = '0.50';
                document.getElementById('axisTiltSlider').value = 0.5;
                document.getElementById('axisTiltValue').textContent = '0.50';
                document.getElementById('axisZoomSlider').value = 0.5;
                document.getElementById('axisZoomValue').textContent = '0.50';
                document.getElementById('axisSlideSlider').value = 0.5;
                document.getElementById('axisSlideValue').textContent = '0.50';
                
                updateStatus('All axes reset to center');
                isConnected = true;
            } catch (error) {
                console.error('Reset all axes failed:', error);
                isConnected = false;
            }
            updateConnectionStatus();
        }

        async function checkConnection() {
            try {
                const response = await fetch('/api/status', {method: 'GET'});
                if (response.ok) {
                    isConnected = true;
                } else {
                    isConnected = false;
                }
            } catch (error) {
                console.error('Connection test failed:', error);
                isConnected = false;
            }
            updateConnectionStatus();
        }

        function updateStatus(message) {
            document.getElementById('statusText').textContent = message;
        }

        // Joystick functions
        function setupJoystick() {
            const canvas = document.getElementById('joyCanvas');
            const ctx = canvas.getContext('2d');
            const joyX = document.getElementById('joyX');
            const joyY = document.getElementById('joyY');
            const joyHint = document.getElementById('joyHint');
            const reconnectBtn = document.getElementById('joyReconnectBtn');
            const sliderGroup = document.getElementById('sliderJoystickGroup');
            
            console.log('Setting up joystick, elements found:', {
                canvas: !!canvas,
                joyX: !!joyX,
                joyY: !!joyY,
                joyHint: !!joyHint,
                reconnectBtn: !!reconnectBtn,
                sliderGroup: !!sliderGroup
            });
            
            // Setup canvas
            drawJoystick(ctx, 0, 0);
            
            // Setup reconnect button
            reconnectBtn.addEventListener('click', async () => {
                try {
                    const r = await fetch('/api/joystick/rescan', { method: 'POST' });
                    if (r.ok) {
                        console.log('Joystick rescan requested');
                        joyHint.textContent = 'Rescan en cours...';
                    }
                } catch (e) {
                    console.warn('Rescan joystick failed', e);
                }
            });
            
            // Setup fallback sliders
            const panOffset = document.getElementById('panOffset');
            const tiltOffset = document.getElementById('tiltOffset');
            const panOffsetValue = document.getElementById('panOffsetValue');
            const tiltOffsetValue = document.getElementById('tiltOffsetValue');
            
            panOffset.addEventListener('input', function() {
                const value = parseFloat(this.value);
                panOffsetValue.textContent = value.toFixed(2);
                sendJoystickPan(value);
            });
            
            tiltOffset.addEventListener('input', function() {
                const value = parseFloat(this.value);
                tiltOffsetValue.textContent = value.toFixed(2);
                sendJoystickTilt(value);
            });
            
            // Start joystick polling
            pollJoystick();
        }
        
        function drawJoystick(ctx, x, y) {
            const centerX = 90;
            const centerY = 90;
            const radius = 80;
            
            // Clear canvas
            ctx.clearRect(0, 0, 180, 180);
            
            // Draw circle
            ctx.strokeStyle = '#007bff';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
            ctx.stroke();
            
            // Draw center cross
            ctx.strokeStyle = '#6c757d';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(centerX - 10, centerY);
            ctx.lineTo(centerX + 10, centerY);
            ctx.moveTo(centerX, centerY - 10);
            ctx.lineTo(centerX, centerY + 10);
            ctx.stroke();
            
            // Draw joystick position
            if (x !== 0 || y !== 0) {
                const posX = centerX + (x * radius * 0.8);
                const posY = centerY + (y * radius * 0.8);
                
                ctx.fillStyle = '#dc3545';
                ctx.beginPath();
                ctx.arc(posX, posY, 8, 0, 2 * Math.PI);
                ctx.fill();
            }
        }
        
        async function pollJoystick() {
            try {
                const response = await fetch('/api/joystick/state');
                if (response.ok) {
                    const js = await response.json();
                    console.log('Joystick state:', js);
                    
                    const joyX = document.getElementById('joyX');
                    const joyY = document.getElementById('joyY');
                    const joyHint = document.getElementById('joyHint');
                    const sliderGroup = document.getElementById('sliderJoystickGroup');
                    const canvas = document.getElementById('joyCanvas');
                    
                    if (!joyX || !joyY || !joyHint || !sliderGroup || !canvas) {
                        console.error('Missing joystick elements:', {joyX, joyY, joyHint, sliderGroup, canvas});
                        return;
                    }
                    
                    const ctx = canvas.getContext('2d');
                    
                    if (js.connected) {
                        joyX.textContent = js.x.toFixed(2);
                        joyY.textContent = js.y.toFixed(2);
                        joyHint.textContent = js.name ? `‚úÖ ${js.name}` : '‚úÖ Joystick connect√©';
                        sliderGroup.style.display = 'none';
                        drawJoystick(ctx, js.x, js.y);
                        console.log('Joystick connected, display updated');
                    } else {
                        joyX.textContent = '0.00';
                        joyY.textContent = '0.00';
                        joyHint.textContent = '‚ùå Aucun joystick d√©tect√© (les faders restent actifs).';
                        sliderGroup.style.display = 'flex';
                        drawJoystick(ctx, 0, 0);
                        console.log('Joystick not connected');
                    }
                } else {
                    console.error('Joystick API response not ok:', response.status);
                }
            } catch (error) {
                console.error('Joystick polling failed:', error);
            }
            
            // Poll every 100ms
            setTimeout(pollJoystick, 100);
        }
        
        async function sendJoystickPan(value) {
            try {
                await fetch('/api/joystick/pan', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({value: value})
                });
            } catch (error) {
                console.error('Joystick pan command failed:', error);
            }
        }
        
        async function sendJoystickTilt(value) {
            try {
                await fetch('/api/joystick/tilt', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({value: value})
                });
            } catch (error) {
                console.error('Joystick tilt command failed:', error);
            }
        }
        
        async function resetJoystickOffsets() {
            try {
                await fetch('/api/offset/zero', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({pan: true, tilt: true})
                });
                
                // Reset sliders
                document.getElementById('panOffset').value = 0;
                document.getElementById('tiltOffset').value = 0;
                document.getElementById('panOffsetValue').textContent = '0.00';
                document.getElementById('tiltOffsetValue').textContent = '0.00';
                
                updateStatus('Joystick offsets reset');
            } catch (error) {
                console.error('Reset joystick offsets failed:', error);
            }
        }

        function updateConnectionStatus() {
            const status = document.getElementById('connectionStatus');
            if (isConnected) {
                status.textContent = 'üü¢ Connected';
                status.className = 'connection-status status-connected';
            } else {
                status.textContent = 'üî¥ Disconnected';
                status.className = 'connection-status status-disconnected';
            }
        }
    </script>
</body>
</html>
